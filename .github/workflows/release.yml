name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install opencv-python pyzbar Pillow pyautogui numpy pyinstaller
        
    - name: Copy required DLL files
      run: |
        python -c "
        import pyzbar, shutil, os
        from pathlib import Path
        pyzbar_path = Path(pyzbar.__file__).parent
        shutil.copy(pyzbar_path / 'libiconv.dll', '.')
        shutil.copy(pyzbar_path / 'libzbar-64.dll', '.')
        print('DLL files copied successfully')
        "
        
    - name: Build executable
      run: |
        pyinstaller --onefile --windowed --name "QRiftly" --add-binary "libiconv.dll;." --add-binary "libzbar-64.dll;." qr_scanner.py
        
    - name: Get version from tag
      id: get_version
      shell: bash
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.VERSION }}
        release_name: QRiftly ${{ steps.get_version.outputs.VERSION }}
        body: |
          # QRiftly - Desktop QR Code Scanner
          
          ## ğŸš€ Features
          - ğŸ“¸ **Screenshot Scanning** - Select any area of your screen
          - ğŸ“ **File Scanning** - Drag & drop or browse image files
          - ğŸ“· **Webcam Scanning** - Real-time camera detection
          - ğŸ“¶ **WiFi Auto-Connect** - One-click WiFi network connection
          - ğŸ”’ **100% Offline** - No internet required for core functionality
          - ğŸ¨ **Modern UI** - Clean, responsive Windows interface
          
          ## ğŸ“¦ Download & Install
          1. Download `QRiftly.exe` below
          2. Run the executable (no installation required!)
          3. Start scanning QR codes instantly
          
          ## ğŸ›¡ï¸ Security
          - All QR scanning happens locally on your device
          - WiFi connections use Windows native security
          - No data sent to external servers
          
          ## ğŸ› Support
          Found a bug or have a suggestion? Please [open an issue](https://github.com/anubhav-n-mishra/Desktop-QR-Scanner/issues)!
        draft: false
        prerelease: false
        
    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist/QRiftly.exe
        asset_name: QRiftly.exe
        asset_content_type: application/octet-stream